<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æš—å·åŒ–ãƒ—ãƒ­ã‚­ã‚·ãƒ–ãƒ©ã‚¦ã‚¶</title>
    <style>
        body { background: #0a0a0a; color: #00ff88; font-family: 'Courier New', monospace; margin: 20px; }
        input { width: 70%; padding: 12px; background: #111; color: #fff; border: 2px solid #00ff88; border-radius: 5px; }
        button { padding: 12px 24px; background: #8a2be2; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #9a3bf2; }
        iframe { width: 100%; height: 70vh; border: 2px solid #333; border-radius: 5px; margin-top: 20px; }
        .status { padding: 10px; background: #111; border-left: 4px solid #00ff88; margin: 10px 0; }
        .server-info { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 8px 12px; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="server-info" id="serverInfo">ã‚µãƒ¼ãƒãƒ¼: æ¥ç¶šä¸­...</div>
    
    <h1>ğŸ” æš—å·åŒ–ãƒ—ãƒ­ã‚­ã‚·ãƒ–ãƒ©ã‚¦ã‚¶</h1>
    <p>Renderã‚µãƒ¼ãƒãƒ¼: <code>proxy-server-ckjw.onrender.com</code></p>
    
    <div>
        <input type="text" id="urlInput" placeholder="https://example.com" value="https://www.google.com">
        <button onclick="loadPage()">æš—å·åŒ–ã—ã¦èª­ã¿è¾¼ã¿</button>
    </div>
    
    <div class="status" id="status">æº–å‚™å®Œäº†ã€‚URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</div>
    
    <iframe id="browserFrame" sandbox="allow-scripts allow-same-origin"></iframe>
    
    <div style="margin-top: 20px;">
        <h3>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹:</h3>
        <button onclick="quickLoad('https://www.google.com')" style="margin: 3px;">Google</button>
        <button onclick="quickLoad('https://www.youtube.com')" style="margin: 3px;">YouTube</button>
        <button onclick="quickLoad('https://github.com')" style="margin: 3px;">GitHub</button>
        <button onclick="quickLoad('https://wikipedia.org')" style="margin: 3px;">Wikipedia</button>
        <button onclick="quickLoad('https://stackoverflow.com')" style="margin: 3px;">StackOverflow</button>
    </div>
    
    <script>
        // ã‚µãƒ¼ãƒãƒ¼URL - ã‚ãªãŸã®Renderã‚µãƒ¼ãƒãƒ¼
        const SERVER_URL = 'https://proxy-server-ckjw.onrender.com';
        
        // æš—å·åŒ–ã‚¯ãƒ©ã‚¹
        class Encryptor {
            constructor() {
                this.secretKey = 'y-redhat-testserver-2024';
            }
            
            // ã‚«ã‚¹ã‚¿ãƒ æš—å·åŒ–é–¢æ•°
            encrypt(text) {
                // è¤‡åˆæš—å·åŒ–: Base64 + é€†é † + ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒ•ãƒˆ
                let encrypted = btoa(text);
                
                // é€†é †
                encrypted = encrypted.split('').reverse().join('');
                
                // æ–‡å­—ã‚·ãƒ•ãƒˆ
                let shifted = '';
                for (let i = 0; i < encrypted.length; i++) {
                    const charCode = encrypted.charCodeAt(i);
                    // ã‚·ãƒ•ãƒˆé‡ã‚’ã‚­ãƒ¼ã‹ã‚‰è¨ˆç®—
                    const shift = this.secretKey.charCodeAt(i % this.secretKey.length) % 10;
                    shifted += String.fromCharCode(charCode + shift);
                }
                
                // å†åº¦Base64
                return btoa(shifted);
            }
            
            // ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦é€ä¿¡ç”¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
            createRequest(url) {
                const encrypted = this.encrypt(url);
                const timestamp = Date.now();
                const requestId = Math.random().toString(36).substring(2);
                
                return {
                    req: 'fetch',
                    data: encrypted,
                    ts: timestamp,
                    id: requestId,
                    v: '1.0'
                };
            }
        }
        
        const encryptor = new Encryptor();
        
        // ãƒ¡ã‚¤ãƒ³é–¢æ•°
        async function loadPage() {
            let url = document.getElementById('urlInput').value.trim();
            if (!url) {
                showStatus('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // URLãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè£œæ­£
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            
            showStatus('æš—å·åŒ–ä¸­...', 'info');
            
            try {
                // 1. URLã‚’æš—å·åŒ–
                const requestData = encryptor.createRequest(url);
                
                // 2. Renderã‚µãƒ¼ãƒãƒ¼ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch(SERVER_URL + '/api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Client': 'encrypted-browser'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // 3. çµæœã‚’è¡¨ç¤º
                const frame = document.getElementById('browserFrame');
                
                // ãƒ™ãƒ¼ã‚¹URLã‚’è¨­å®š
                const baseTag = `<base href="${url}">`;
                
                // CSSã§åˆ¶é™ã‚’è¿½åŠ 
                const restrictCSS = `
                    <style>
                        iframe, frame, frameset {
                            display: none !important;
                        }
                        [onload*="window.location"],
                        [href*="javascript:"],
                        [onclick*="location.href"] {
                            pointer-events: none !important;
                            opacity: 0.5 !important;
                        }
                    </style>
                `;
                
                frame.srcdoc = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        ${baseTag}
                        ${restrictCSS}
                    </head>
                    <body>
                        ${result.html || 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“'}
                        <div style="position: fixed; bottom: 10px; right: 10px; 
                                   background: rgba(0,0,0,0.8); color: #00ff88; 
                                   padding: 8px 12px; border-radius: 5px; font-size: 12px;">
                            ğŸ” æš—å·åŒ–ãƒ—ãƒ­ã‚­ã‚·çµŒç”±
                        </div>
                    </body>
                    </html>
                `;
                
                showStatus(`âœ… èª­ã¿è¾¼ã¿æˆåŠŸ: ${new URL(url).hostname}`, 'success');
                updateServerInfo('æ¥ç¶šæ¸ˆã¿');
                
            } catch (error) {
                showStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateServerInfo('ã‚¨ãƒ©ãƒ¼');
            }
        }
        
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            
            const colors = {
                info: '#00d4ff',
                success: '#00ff88',
                error: '#ff4757',
                warning: '#ffa502'
            };
            
            statusDiv.style.borderLeftColor = colors[type] || colors.info;
        }
        
        function updateServerInfo(message) {
            document.getElementById('serverInfo').textContent = `ã‚µãƒ¼ãƒãƒ¼: ${message}`;
        }
        
        function quickLoad(url) {
            document.getElementById('urlInput').value = url;
            loadPage();
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // Enterã‚­ãƒ¼ã§å®Ÿè¡Œ
            document.getElementById('urlInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadPage();
                }
            });
            
            // ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆ
            fetch(SERVER_URL + '/health')
                .then(response => response.json())
                .then(data => {
                    updateServerInfo('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ âœ“');
                    showStatus('ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šå®Œäº†', 'success');
                })
                .catch(error => {
                    updateServerInfo('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ âœ—');
                    showStatus('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“', 'error');
                });
        });
    </script>
</body>
</html>
