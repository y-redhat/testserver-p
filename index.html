<!DOCTYPE html>
<html>
<head>
    <title>æš—å·åŒ–ãƒ—ãƒ­ã‚­ã‚·</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; margin: 20px; }
        input { width: 60%; padding: 10px; background: #111; color: #0f0; border: 1px solid #0f0; }
        button { padding: 10px 20px; background: #0f0; color: #000; border: none; cursor: pointer; margin: 5px; }
        iframe { width: 100%; height: 70vh; border: 1px solid #0f0; margin-top: 20px; }
        .status { padding: 10px; background: #111; margin: 10px 0; }
        .mode-btn { background: #222; border: 1px solid #444; color: #ccc; }
        .mode-btn.active { background: #0f0; color: #000; border-color: #0f0; }
    </style>
</head>
<body>
    <h1>ğŸ” æš—å·åŒ–ãƒ—ãƒ­ã‚­ã‚·</h1>
    
    <div>
        <input id="url" placeholder="https://example.com" value="https://www.google.com">
        <button onclick="loadPage()">ãƒ­ãƒ¼ãƒ‰</button>
    </div>
    
    <div style="margin: 10px 0;">
        <button class="mode-btn active" onclick="setMode('aes')">ğŸ” AES</button>
        <button class="mode-btn" onclick="setMode('xor')">ğŸ”‘ XOR</button>
        <button class="mode-btn" onclick="setMode('base64')">ğŸ“¦ Base64</button>
    </div>
    
    <div class="status" id="status">æº–å‚™å®Œäº†</div>
    <iframe id="frame"></iframe>
    
    <div style="margin-top: 20px; font-size: 12px; color: #666;">
        æš—å·åŒ–ãƒ¢ãƒ¼ãƒ‰: <span id="modeText">AES-256</span> | ã‚µãƒ¼ãƒãƒ¼: <span id="serverStatus">æ¥ç¶šä¸­...</span>
    </div>

    <script>
        // æš—å·åŒ–ã‚¯ãƒ©ã‚¹
        class Encryptor {
            constructor() {
                this.mode = 'aes';
                this.key = this.generateKey();
                this.server = 'https://proxy-server-ckjw.onrender.com';
            }
            
            generateKey() {
                // 32ãƒã‚¤ãƒˆã®ã‚­ãƒ¼ã‚’ç”Ÿæˆ
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }
            
            // AESæš—å·åŒ–
            async encryptAES(text) {
                const encoder = new TextEncoder();
                const data = encoder.encode(text);
                
                const keyMaterial = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode(this.key.substring(0, 32)),
                    { name: 'AES-CBC' },
                    false,
                    ['encrypt']
                );
                
                const iv = crypto.getRandomValues(new Uint8Array(16));
                const encrypted = await crypto.subtle.encrypt(
                    { name: 'AES-CBC', iv: iv },
                    keyMaterial,
                    data
                );
                
                const result = new Uint8Array(iv.length + encrypted.byteLength);
                result.set(iv, 0);
                result.set(new Uint8Array(encrypted), iv.length);
                
                return btoa(String.fromCharCode(...result));
            }
            
            // XORæš—å·åŒ–ï¼ˆç°¡æ˜“ï¼‰
            encryptXOR(text) {
                let result = '';
                const key = this.key;
                for (let i = 0; i < text.length; i++) {
                    const charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                    result += String.fromCharCode(charCode);
                }
                return btoa(result);
            }
            
            // Base64å¤šé‡æš—å·åŒ–
            encryptBase64(text) {
                let encoded = btoa(text);
                // é€†é † + å›è»¢
                encoded = encoded.split('').reverse().join('');
                encoded = btoa(encoded);
                return encoded;
            }
            
            async encrypt(text) {
                switch(this.mode) {
                    case 'aes':
                        return await this.encryptAES(text);
                    case 'xor':
                        return this.encryptXOR(text);
                    case 'base64':
                        return this.encryptBase64(text);
                    default:
                        return btoa(text);
                }
            }
        }
        
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†
        const encryptor = new Encryptor();
        
        function setMode(mode) {
            encryptor.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            const modeNames = {
                'aes': 'AES-256æš—å·åŒ–',
                'xor': 'XORæš—å·åŒ–',
                'base64': 'Base64å¤šé‡æš—å·åŒ–'
            };
            document.getElementById('modeText').textContent = modeNames[mode];
            showStatus(`æš—å·åŒ–ãƒ¢ãƒ¼ãƒ‰: ${modeNames[mode]}`);
        }
        
        async function loadPage() {
            let url = document.getElementById('url').value.trim();
            if (!url) return;
            
            if (!url.startsWith('http')) {
                url = 'https://' + url;
            }
            
            showStatus('æš—å·åŒ–ä¸­...');
            
            try {
                // 1. URLã‚’æš—å·åŒ–
                const encryptedUrl = await encryptor.encrypt(url);
                
                // 2. æš—å·åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡
                const response = await fetch(`${encryptor.server}/api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Request-Type': 'data-fetch', // å½è£…ãƒ˜ãƒƒãƒ€ãƒ¼
                        'X-API-Version': '1.0'
                    },
                    body: JSON.stringify({
                        action: 'get_content',
                        data: encryptedUrl,
                        mode: encryptor.mode,
                        timestamp: Date.now()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // 3. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¡¨ç¤º
                const frame = document.getElementById('frame');
                
                if (result.html) {
                    // é€šå¸¸ã®HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹
                    frame.srcdoc = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <base href="${url}">
                            <style>
                                body { margin: 20px; }
                                * { max-width: 100%; }
                            </style>
                        </head>
                        <body>
                            ${result.html}
                            <div style="position: fixed; bottom: 10px; right: 10px; 
                                       background: rgba(0,0,0,0.7); color: #0f0; 
                                       padding: 5px 10px; border-radius: 5px; font-size: 12px;">
                                ğŸ” æš—å·åŒ–ãƒ—ãƒ­ã‚­ã‚·çµŒç”±
                            </div>
                        </body>
                        </html>
                    `;
                } else if (result.iframe) {
                    // iframeåŸ‹ã‚è¾¼ã¿
                    frame.srcdoc = result.iframe;
                }
                
                showStatus(`âœ… èª­ã¿è¾¼ã¿æˆåŠŸ: ${new URL(url).hostname}`);
                document.getElementById('serverStatus').textContent = 'æ¥ç¶šæ¸ˆã¿';
                
            } catch(error) {
                showStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                document.getElementById('serverStatus').textContent = 'ã‚¨ãƒ©ãƒ¼';
            }
        }
        
        function showStatus(message) {
            document.getElementById('status').textContent = message;
        }
        
        // ãƒ†ã‚¹ãƒˆæ¥ç¶š
        async function testConnection() {
            try {
                const response = await fetch(`${encryptor.server}/health`);
                if (response.ok) {
                    document.getElementById('serverStatus').textContent = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';
                }
            } catch(e) {
                document.getElementById('serverStatus').textContent = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³';
            }
        }
        
        // åˆæœŸåŒ–
        document.getElementById('url').onkeypress = e => e.key === 'Enter' && loadPage();
        setTimeout(testConnection, 1000);
        
        // ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ³ã‚¯
        function quickLoad(site) {
            document.getElementById('url').value = site;
            loadPage();
        }
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'l') {
                document.getElementById('url').focus();
                document.getElementById('url').select();
            }
        });
    </script>
    
    <div style="margin-top: 20px;">
        <button onclick="quickLoad('https://www.google.com')" style="font-size: 12px;">Google</button>
        <button onclick="quickLoad('https://www.youtube.com')" style="font-size: 12px;">YouTube</button>
        <button onclick="quickLoad('https://github.com')" style="font-size: 12px;">GitHub</button>
        <button onclick="quickLoad('https://wikipedia.org')" style="font-size: 12px;">Wikipedia</button>
    </div>
</body>
</html>
